<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¤×¨×™×˜×™× ×©×‘×•×¢×™×™×</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #4a90e2;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .controls {
            padding: 15px;
            background: #f8f9fa;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .week-selector {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin: 0 10px;
        }

        .content {
            padding: 20px;
        }

        .week-section {
            margin-bottom: 30px;
        }

        .week-title {
            background: #90c695;
            color: black;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            border: 1px solid #333;
        }

        .week-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .week-table th,
        .week-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
            vertical-align: top;
        }

        .week-table th {
            background: #e8e8e8;
            font-weight: bold;
        }

        .menu-name {
            background: #f0f0f0;
            font-weight: bold;
            width: 150px;
        }

        .day-cell {
            width: 150px;
            min-height: 80px;
            padding: 5px;
        }

        .menu-items {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: right;
        }

        .menu-item {
            font-size: 12px;
            padding: 2px 0;
            border-bottom: 1px dotted #ccc;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .no-items {
            color: #999;
            font-style: italic;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .week-table {
                font-size: 12px;
            }
            
            .day-cell {
                width: 120px;
                padding: 3px;
            }
            
            .menu-item {
                font-size: 10px;
            }
        }

        .menu-filter-btn {
            padding: 10px 20px;
            background: #5a67d8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
            position: relative;
        }

        .menu-filter-btn:hover {
            background: #4c51bf;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #5a67d8;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 5px;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-dropdown-header {
            background: #5a67d8;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-dropdown-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-dropdown-item:hover {
            background: #f5f7fa;
        }

        .menu-dropdown-item:last-child {
            border-bottom: none;
        }

        .menu-dropdown-item input[type="checkbox"] {
            margin-left: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .menu-dropdown-item label {
            cursor: pointer;
            flex: 1;
            margin-right: 10px;
        }

        .menu-count-badge {
            background: #e53e3e;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 8px;
        }

        .filter-wrapper {
            position: relative;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… ×ª×¤×¨×™×˜×™× ×©×‘×•×¢×™×™×</h1>
            <p>×ª×¦×•×’×ª ×˜×‘×œ××•×ª ×œ×¤×™ ×©×‘×•×¢×•×ª</p>
        </div>
        
        <div class="controls">
            <div style="margin-bottom: 15px;">
                <button id="loadFromServer" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px;">
                    ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×
                </button>
                <button id="downloadPDF" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; margin-right: 10px;">
                    ğŸ“„ ×”×•×¨×“ PDF
                </button>
            </div>
            
            <div>
                <label for="weekSelect">×‘×—×¨ ×©×‘×•×¢:</label>
                <select id="weekSelect" class="week-selector">
                    <option value="all">×›×œ ×”×©×‘×•×¢×•×ª</option>
                    <option value="1">×©×‘×•×¢ 1</option>
                    <option value="2">×©×‘×•×¢ 2</option>
                    <option value="3">×©×‘×•×¢ 3</option>
                    <option value="4">×©×‘×•Ø¹ 4</option>
                </select>
            </div>

            <div style="position: relative;">
                <button id="menuFilterBtn" class="menu-filter-btn">
                    ğŸ“‹ ×‘×—×¨ ×ª×¤×¨×™×˜×™× â–¼
                </button>
                <div id="menuDropdown" class="menu-dropdown">
                    <!-- ×™×ª××œ× ×‘××•×¤×Ÿ ×“×™× ××™ -->
                </div>
            </div>
        </div>

        <div class="content">
            <div id="weeklyTables" class="loading">
                ×˜×•×¢×Ÿ × ×ª×•× ×™×...
            </div>
        </div>
    </div>

    <script>
        // ×›×ª×•×‘×ª ×”×©×¨×ª
        const SERVER_URL = 'https://priority-proxy.lyzer-64d.workers.dev';

        // × ×ª×•× ×™ ×”×ª×¤×¨×™×˜×™×
        const realMenuData = {};

        // ××©×™×›×ª × ×ª×•× ×™× ××”×©×¨×ª
        async function loadMenuDataFromServer() {
            try {
                document.getElementById('weeklyTables').innerHTML = '<div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×©×¨×ª...</div>';

                // ×‘× ×™×™×ª ×”×©××™×œ×ª×” - ×œ×œ× fetchAll, ×¢× $top ×’×‘×•×”
                const filterQuery = '$top=5000';
                const url = `${SERVER_URL}?table=CPROFISINGLE&filter=${encodeURIComponent(filterQuery)}`;

                console.log('××•×©×š × ×ª×•× ×™× ××”×©×¨×ª:', url);

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`×©×’×™××ª ×©×¨×ª: ${response.status}`);
                }

                const data = await response.json();
                console.log('× ×ª×•× ×™× ×©×”×ª×§×‘×œ×•:', data);

                // ×”××¨×ª ×”× ×ª×•× ×™× ×œ×¤×•×¨××˜ ×©×œ ×”×ª×¤×¨×™×˜×™×
                const processedData = processServerData(data.value || data);
                return processedData;

            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ××”×©×¨×ª:', error);
                document.getElementById('weeklyTables').innerHTML =
                    '<div class="loading">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ××”×©×¨×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</div>';
                throw error;
            }
        }

        // ×¢×™×‘×•×“ × ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××”×©×¨×ª
        function processServerData(customers) {
            console.log('××¢×‘×“ × ×ª×•× ×™× (×¡×”"×› ×¨×©×•××•×ª):', customers.length);
            console.log('×“×•×’××” ×œ×¨×©×•××”:', customers[0]);
            console.log('×›×œ ×”×©×“×•×ª ×‘×¨×©×•××”:', customers[0] ? Object.keys(customers[0]) : '××™×Ÿ × ×ª×•× ×™×');

            // ×¡×™× ×•×Ÿ - ×¨×§ ×œ×§×•×—×•×ª ×ª×¤×¨×™×˜×™ ××–×•×Ÿ
            const filtered = customers.filter(customer =>
                customer.CUSTDES && customer.CUSTDES === '×œ×§×•×— ×œ×ª×¤×¨×™×˜×™ ××–×•×Ÿ'
            );

            console.log('××—×¨×™ ×¡×™× ×•×Ÿ ×œ×ª×¤×¨×™×˜×™ ××–×•×Ÿ:', filtered.length, '×œ×§×•×—×•×ª');
            console.log('×“×•×’××” ×œ×œ×§×•×— ×ª×¤×¨×™×˜×™ ××–×•×Ÿ:', filtered[0]);

            // ×¢×™×‘×•×“ ×”× ×ª×•× ×™× - ×‘× ×™×™×ª ××‘× ×” ×”×ª×¤×¨×™×˜×™× ×”×©×‘×•×¢×™×™×
            const weeklyMenus = {};

            filtered.forEach(row => {
                const menuDesc = row.Y_36311_0_ESH; // ×ª×™××•×¨ ×ª×¤×¨×™×˜ - ×›×•×œ×œ "×©×‘×•×¢ X ×™×•× Y"
                const productDesc = row.PDES; // ×ª×™××•×¨ ××•×¦×¨
                const customerName = row.CUSTDES; // ×©× ×œ×§×•×—

                if (menuDesc && productDesc) {
                    // ×—×™×œ×•×¥ ×©×‘×•×¢ ×•×™×•× ××ª×™××•×¨ ×”×ª×¤×¨×™×˜
                    const weekMatch = menuDesc.match(/×©×‘×•×¢ (\d+)/);
                    const dayMatch = menuDesc.match(/×™×•× ([×-×”])/);

                    if (weekMatch && dayMatch) {
                        // ×—×™×œ×•×¥ ×©× ×”×ª×¤×¨×™×˜ (×”×˜×§×¡×˜ ×œ×¤× ×™ "×©×‘×•×¢")
                        const baseName = menuDesc.split('×©×‘×•×¢')[0].trim().replace(/\/$/, '').trim();
                        const week = weekMatch[1];
                        const day = dayMatch[1];

                        // ×™×¦×™×¨×ª ×”××‘× ×”
                        if (!weeklyMenus[baseName]) {
                            weeklyMenus[baseName] = {};
                        }

                        if (!weeklyMenus[baseName][week]) {
                            weeklyMenus[baseName][week] = {};
                        }

                        if (!weeklyMenus[baseName][week][day]) {
                            weeklyMenus[baseName][week][day] = [];
                        }

                        // ×”×•×¡×¤×ª ×”××•×¦×¨ (×× ×œ× ×§×™×™×)
                        if (!weeklyMenus[baseName][week][day].includes(productDesc)) {
                            weeklyMenus[baseName][week][day].push(productDesc);
                        }
                    }
                }
            });

            console.log('×ª×¤×¨×™×˜×™× ×©× ×‘× ×•:', weeklyMenus);
            console.log('××¡×¤×¨ ×ª×¤×¨×™×˜×™×:', Object.keys(weeklyMenus).length);

            return weeklyMenus;
        }

        // ×§×¨×™××ª × ×ª×•× ×™× ××§×•×‘×¥ ×©×”×•×¢×œ×” (×©××¨×ª×™ ××ª ×”×¤×•× ×§×¦×™×” ×”×™×©× ×”)
        async function loadMenuData(file) {
            try {
                const response = await readFileAsArrayBuffer(file);

                // ×˜×¢×™× ×ª ×¡×¤×¨×™×™×ª XLSX ×× ×¢×“×™×™×Ÿ ×œ× × ×˜×¢× ×”
                if (typeof XLSX === 'undefined') {
                    await loadXLSXLibrary();
                }

                const workbook = XLSX.read(response, {
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true,
                    cellNF: true,
                    sheetStubs: true
                });

                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const processedData = processMenuData(jsonData);
                return processedData;

            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×:', error);
                alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. ×× × ×‘×“×•×§ ×©×”×§×•×‘×¥ ×ª×§×™×Ÿ ×•××›×™×œ ××ª ×”×¢××•×“×•×ª ×”× ×“×¨×©×•×ª.');
                throw error;
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×¡×¤×¨×™×™×ª XLSX
        function loadXLSXLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof XLSX !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×¡×¤×¨×™×™×ª XLSX'));
                
                document.head.appendChild(script);
            });
        }

        // ×¤×•× ×§×¦×™×” ×œ×§×¨×™××ª ×§×•×‘×¥ ×›-ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        function processMenuData(jsonData) {
            const weeklyMenus = {};
            
            jsonData.forEach(row => {
                const menuDesc = row['×ª××•×¨ ×ª×¤×¨×™×˜'];
                const productDesc = row['×ª××•×¨ ××•×¦×¨'];
                
                if (menuDesc && productDesc && typeof menuDesc === 'string') {
                    const weekMatch = menuDesc.match(/×©×‘×•×¢ (\d+)/);
                    const dayMatch = menuDesc.match(/×™×•× ([×-×”])/);
                    
                    if (weekMatch && dayMatch) {
                        const baseName = menuDesc.split('×©×‘×•×¢')[0].trim().replace(/\/$/, '').trim();
                        const week = weekMatch[1];
                        const day = dayMatch[1];
                        
                        if (!weeklyMenus[baseName]) {
                            weeklyMenus[baseName] = {};
                        }
                        
                        if (!weeklyMenus[baseName][week]) {
                            weeklyMenus[baseName][week] = {};
                        }
                        
                        if (!weeklyMenus[baseName][week][day]) {
                            weeklyMenus[baseName][week][day] = [];
                        }
                        
                        if (!weeklyMenus[baseName][week][day].includes(productDesc)) {
                            weeklyMenus[baseName][week][day].push(productDesc);
                        }
                    }
                }
            });
            
            return weeklyMenus;
        }

        function generateWeekTable(weekNumber, menuData) {
            const days = ['×', '×‘', '×’', '×“', '×”'];
            
            let html = `
                <div class="week-section">
                    <div class="week-title">×©×‘×•×¢ ${weekNumber}</div>
                    <table class="week-table">
                        <thead>
                            <tr>
                                <th>×©× ×ª×¤×¨×™×˜</th>
                                <th>×</th>
                                <th>×‘</th>
                                <th>×’</th>
                                <th>×“</th>
                                <th>×”</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // ×›×œ ×ª×¤×¨×™×˜ ×‘×©×•×¨×” × ×¤×¨×“×ª
            Object.keys(menuData).forEach(menuName => {
                const menuWeekData = menuData[menuName][weekNumber];
                
                if (menuWeekData) {
                    html += `<tr>`;
                    html += `<td class="menu-name">${menuName}</td>`;
                    
                    days.forEach(day => {
                        const items = menuWeekData[day] || [];
                        
                        html += `<td class="day-cell">`;
                        
                        if (items.length > 0) {
                            html += '<ul class="menu-items">';
                            items.forEach(item => {
                                html += `<li class="menu-item">${item}</li>`;
                            });
                            html += '</ul>';
                        } else {
                            html += '<div class="no-items">-</div>';
                        }
                        
                        html += '</td>';
                    });
                    
                    html += `</tr>`;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function displayWeeklyTables(menuData, selectedWeek = 'all') {
            const weeklyTables = document.getElementById('weeklyTables');

            if (!menuData || Object.keys(menuData).length === 0) {
                weeklyTables.innerHTML = '<div class="loading">×œ× × ××¦××• × ×ª×•× ×™×</div>';
                return;
            }

            // ××™×¡×•×£ ×›×œ ×”×©×‘×•×¢×•×ª ×”×–××™× ×™×
            const availableWeeks = new Set();
            Object.values(menuData).forEach(menu => {
                Object.keys(menu).forEach(week => {
                    availableWeeks.add(week);
                });
            });

            const sortedWeeks = Array.from(availableWeeks).sort((a, b) => parseInt(a) - parseInt(b));

            let html = '';

            if (selectedWeek === 'all') {
                sortedWeeks.forEach(week => {
                    html += generateWeekTable(week, menuData);
                });
            } else {
                html += generateWeekTable(selectedWeek, menuData);
            }

            // ×¢×“×›×•×Ÿ ×—×œ×§ ×©×œ ×”×ª×¦×•×’×”
            requestAnimationFrame(() => {
                weeklyTables.innerHTML = html;
            });
        }

        // ××™×¨×•×¢×™×
        let currentMenus = {};
        let allMenuNames = [];

        // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×ª×¤×¨×™×˜×™× ×‘-dropdown
        function updateMenuSelect(menuData) {
            allMenuNames = Object.keys(menuData).sort();
            const menuDropdown = document.getElementById('menuDropdown');

            // ×™×¦×™×¨×ª ×¨×©×™××ª checkboxes
            let html = `
                <div class="menu-dropdown-item">
                    <input type="checkbox" id="menu-all" value="all" checked onchange="handleMenuCheckboxChange(this)">
                    <label for="menu-all">×›×œ ×”×ª×¤×¨×™×˜×™×</label>
                </div>
            `;

            allMenuNames.forEach((menuName, index) => {
                const id = `menu-${index}`;
                html += `
                    <div class="menu-dropdown-item">
                        <input type="checkbox" id="${id}" value="${menuName}" onchange="handleMenuCheckboxChange(this)">
                        <label for="${id}">${menuName}</label>
                    </div>
                `;
            });

            menuDropdown.innerHTML = html;
        }

        // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×”×ª×¤×¨×™×˜×™× ×©× ×‘×—×¨×•
        function getSelectedMenus() {
            const checkboxes = document.querySelectorAll('#menuDropdown input[type="checkbox"]:checked');
            const selectedValues = Array.from(checkboxes).map(cb => cb.value);

            // ×× × ×‘×—×¨ "×›×œ ×”×ª×¤×¨×™×˜×™×" ××• ×œ× × ×‘×—×¨ ×›×œ×•×
            if (selectedValues.includes('all') || selectedValues.length === 0) {
                return allMenuNames;
            }

            return selectedValues;
        }

        // ×˜×™×¤×•×œ ×‘×©×™× ×•×™×™ checkboxes
        function handleMenuCheckboxChange(checkbox) {
            const allCheckbox = document.getElementById('menu-all');

            if (checkbox.value === 'all') {
                // ×× "×›×œ ×”×ª×¤×¨×™×˜×™×" × ×‘×—×¨, × ×¡××Ÿ ××ª ×›×•×œ×
                const allCheckboxes = document.querySelectorAll('#menuDropdown input[type="checkbox"]');
                allCheckboxes.forEach(cb => {
                    if (cb.value !== 'all') {
                        cb.checked = false;
                    }
                });
            } else {
                // ×× ×ª×¤×¨×™×˜ ×¡×¤×¦×™×¤×™ × ×‘×—×¨, × ×‘×˜×œ ××ª "×›×œ ×”×ª×¤×¨×™×˜×™×"
                if (allCheckbox) {
                    allCheckbox.checked = false;
                }
            }

            // ×¢×“×›×•×Ÿ ×”×›×¤×ª×•×¨
            updateMenuButtonText();

            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            displayFilteredTables();
        }

        // ×¢×“×›×•×Ÿ ×˜×§×¡×˜ ×”×›×¤×ª×•×¨
        function updateMenuButtonText() {
            const btn = document.getElementById('menuFilterBtn');
            const selectedMenus = getSelectedMenus();

            if (selectedMenus.length === allMenuNames.length) {
                btn.textContent = 'ğŸ“‹ ×‘×—×¨ ×ª×¤×¨×™×˜×™× â–¼';
            } else {
                btn.textContent = `ğŸ“‹ ${selectedMenus.length} ×ª×¤×¨×™×˜×™× × ×‘×—×¨×• â–¼`;
            }
        }

        // ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×¦×’×ª ×˜×‘×œ××•×ª ×¢× ×¡×™× ×•×Ÿ ×ª×¤×¨×™×˜×™×
        function displayFilteredTables() {
            const selectedWeek = document.getElementById('weekSelect').value;
            const selectedMenus = getSelectedMenus();

            // ×¡×™× ×•×Ÿ ×”×ª×¤×¨×™×˜×™× (×œ×œ× ××©×™×›×ª × ×ª×•× ×™× ××”×©×¨×ª!)
            const filteredMenus = {};
            selectedMenus.forEach(menuName => {
                if (currentMenus[menuName]) {
                    filteredMenus[menuName] = currentMenus[menuName];
                }
            });

            // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×”×ª×¦×•×’×”
            displayWeeklyTables(filteredMenus, selectedWeek);
        }

        document.getElementById('weekSelect').addEventListener('change', displayFilteredTables);

        // ××™×¨×•×¢ ×œ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×ª×¤×¨×™×˜ ×”×‘×—×™×¨×”
        document.getElementById('menuFilterBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('menuDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        // ×¡×’×™×¨×ª ×”×ª×¤×¨×™×˜ ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×•
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('menuDropdown');
            const button = document.getElementById('menuFilterBtn');
            if (!dropdown.contains(e.target) && e.target !== button) {
                dropdown.style.display = 'none';
            }
        });

        // ××™×¨×•×¢ ×œ×˜×¢×™× ×” ××”×©×¨×ª
        document.getElementById('loadFromServer').addEventListener('click', async function() {
            try {
                const newData = await loadMenuDataFromServer();
                currentMenus = newData;

                if (Object.keys(currentMenus).length > 0) {
                    updateMenuSelect(currentMenus);
                    displayFilteredTables();
                    const totalMenus = Object.keys(currentMenus).length;
                    console.log(`×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”! × ××¦××• ${totalMenus} ×ª×¤×¨×™×˜×™×`);
                } else {
                    document.getElementById('weeklyTables').innerHTML = `
                        <div class="loading">
                            ×œ× × ××¦××• ×ª×¤×¨×™×˜×™× ×‘×©×¨×ª.<br>
                            ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ×©×¨×ª ××• × ×¡×” ×©×•×‘.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('×©×’×™××”:', error);
            }
        });

        // ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×‘×¤×ª×™×—×ª ×”×“×£
        (async function loadOnStart() {
            try {
                document.getElementById('weeklyTables').innerHTML = '<div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×©×¨×ª...</div>';

                const newData = await loadMenuDataFromServer();
                currentMenus = newData;

                if (Object.keys(currentMenus).length > 0) {
                    updateMenuSelect(currentMenus);
                    displayFilteredTables();
                    const totalMenus = Object.keys(currentMenus).length;
                    console.log(`×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”! × ××¦××• ${totalMenus} ×ª×¤×¨×™×˜×™×`);
                } else {
                    document.getElementById('weeklyTables').innerHTML = `
                        <div class="loading">
                            ×œ× × ××¦××• ×ª×¤×¨×™×˜×™× ×‘×©×¨×ª.<br>
                            ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ××• × ×¡×” ×©×•×‘.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×” ××•×˜×•××˜×™×ª:', error);
                document.getElementById('weeklyTables').innerHTML = `
                    <div class="loading">
                        ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ××”×©×¨×ª.<br>
                        ğŸ”„ ×œ×—×¥ ×¢×œ "×¨×¢× ×Ÿ × ×ª×•× ×™×" ×œ× ×¡×•×ª ×©×•×‘
                    </div>
                `;
            }
        })();

        // ×”×•×¨×“×ª PDF ×œ×ª×¤×¨×™×˜×™× ×©×‘×•×¢×™×™× - ××¡×•×“×¨ ×œ×¤×™ ×ª×¤×¨×™×˜×™× (×›×œ ×ª×¤×¨×™×˜ ×¢×œ ×“×£ ××—×“)
        function downloadMenuPDF() {
            if (!currentMenus || Object.keys(currentMenus).length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”');
                return;
            }

            // ×§×‘×œ×ª ×”×ª×¤×¨×™×˜×™× ×©× ×‘×—×¨×•
            const selectedMenus = getSelectedMenus();

            // ×‘×“×™×§×” ×©×™×© ×ª×¤×¨×™×˜×™× × ×‘×—×¨×™×
            if (selectedMenus.length === 0) {
                alert('×× × ×‘×—×¨ ×ª×¤×¨×™×˜ ××—×“ ×œ×¤×—×•×ª');
                return;
            }

            // ×™×¦×™×¨×ª ×—×œ×•×Ÿ ×—×“×© ×œ×”×“×¤×¡×”
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ×—×œ×•×Ÿ ×—×“×©. ×× × ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× ×‘×“×¤×“×¤×Ÿ.');
                return;
            }

            // ×‘× ×™×™×ª HTML ×œ×¤×™ ×ª×¤×¨×™×˜×™× - ×›×œ ×ª×¤×¨×™×˜ ×¢× ×›×œ ×”×©×‘×•×¢×•×ª ×©×œ×•
            const days = ['×', '×‘', '×’', '×“', '×”'];
            let contentHTML = '';

            // ×¢×‘×•×¨ ×›×œ ×ª×¤×¨×™×˜ ×©× ×‘×—×¨ ×‘×œ×‘×“
            selectedMenus.sort().forEach((menuName, menuIndex) => {
                const menuWeeks = currentMenus[menuName];

                // ×›×•×ª×¨×ª ×”×ª×¤×¨×™×˜
                contentHTML += `
                    <div class="menu-section" style="page-break-after: always;">
                        <h2 style="background: #4285f4; color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-size: 20pt;">
                            ${menuName}
                        </h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="background-color: #4285f4; color: white; border: 1px solid #000; padding: 10px; text-align: center; font-size: 12pt;">×©×‘×•×¢</th>
                                    <th style="background-color: #4285f4; color: white; border: 1px solid #000; padding: 10px; text-align: center; font-size: 12pt;">×™×•× ×'</th>
                                    <th style="background-color: #4285f4; color: white; border: 1px solid #000; padding: 10px; text-align: center; font-size: 12pt;">×™×•× ×‘'</th>
                                    <th style="background-color: #4285f4; color: white; border: 1px solid #000; padding: 10px; text-align: center; font-size: 12pt;">×™×•× ×’'</th>
                                    <th style="background-color: #4285f4; color: white; border: 1px solid #000; padding: 10px; text-align: center; font-size: 12pt;">×™×•× ×“'</th>
                                    <th style="background-color: #4285f4; color: white; border: 1px solid #000; padding: 10px; text-align: center; font-size: 12pt;">×™×•× ×”'</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // ×¢×‘×•×¨ ×›×œ ×©×‘×•×¢ ×‘×ª×¤×¨×™×˜
                const weekNumbers = Object.keys(menuWeeks).sort((a, b) => parseInt(a) - parseInt(b));
                weekNumbers.forEach((weekNum, weekIndex) => {
                    const weekData = menuWeeks[weekNum];
                    const rowBg = weekIndex % 2 === 0 ? '#ffffff' : '#f9f9f9';

                    contentHTML += `<tr style="background-color: ${rowBg};">`;
                    contentHTML += `<td style="border: 1px solid #000; padding: 10px; text-align: center; font-weight: bold; font-size: 11pt;">×©×‘×•×¢ ${weekNum}</td>`;

                    days.forEach(day => {
                        const items = weekData[day] || [];
                        contentHTML += `<td style="border: 1px solid #000; padding: 8px; text-align: right; vertical-align: top; font-size: 9pt;">`;

                        if (items.length > 0) {
                            contentHTML += '<ul style="margin: 0; padding-right: 15px; list-style-type: disc;">';
                            items.forEach(item => {
                                contentHTML += `<li style="margin-bottom: 3px;">${item}</li>`;
                            });
                            contentHTML += '</ul>';
                        } else {
                            contentHTML += '<div style="text-align: center; color: #999;">-</div>';
                        }

                        contentHTML += '</td>';
                    });

                    contentHTML += '</tr>';
                });

                contentHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // ×™×¦×™×¨×ª HTML ×œ×”×“×¤×¡×”
            printWindow.document.open('text/html', 'replace');
            printWindow.document.write('<!DOCTYPE html>');
            printWindow.document.write('<html lang="he" dir="rtl">');
            printWindow.document.write('<head>');
            printWindow.document.write('<meta charset="UTF-8">');
            printWindow.document.write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
            printWindow.document.write('<title>×ª×¤×¨×™×˜×™× ×©×‘×•×¢×™×™×</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('@page { size: A4 landscape; margin: 15mm; }');
            printWindow.document.write('* { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }');
            printWindow.document.write('body { font-family: Arial, "DejaVu Sans", sans-serif; direction: rtl; margin: 0; padding: 10px; font-size: 10pt; color: #000; background: white; }');
            printWindow.document.write('.menu-section { page-break-after: always; page-break-inside: avoid; }');
            printWindow.document.write('.menu-section:last-child { page-break-after: auto; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; }');
            printWindow.document.write('th, td { border: 1px solid #000; padding: 8px; text-align: right; word-wrap: break-word; }');
            printWindow.document.write('th { background-color: #4285f4 !important; color: white !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }');
            printWindow.document.write('tr:nth-child(even) { background-color: #f9f9f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }');
            printWindow.document.write('@media print { body { margin: 0; padding: 5mm; } .menu-section { page-break-after: always; } .menu-section:last-child { page-break-after: auto; } }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head>');
            printWindow.document.write('<body>');
            printWindow.document.write(contentHTML);
            printWindow.document.write('<script>');
            printWindow.document.write('window.onload = function() { setTimeout(function() { window.print(); }, 500); };');
            printWindow.document.write('<\/script>');
            printWindow.document.write('</body>');
            printWindow.document.write('</html>');
            printWindow.document.close();

            // ×”××ª× ×” ×§×¦×¨×” ×›×“×™ ×©×”×“×£ ×™×˜×¢×Ÿ
            setTimeout(function() {
                if (printWindow.document.body && printWindow.document.body.innerHTML.trim() === '') {
                    console.error('×”×“×£ × ×©××¨ ×¨×™×§');
                    alert('×”×“×£ × ×©××¨ ×¨×™×§. × ×¡×” ×©×•×‘ ××• ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×©×’×™××•×ª.');
                }
            }, 1000);
        }

        // ××™×¨×•×¢ ×œ×”×•×¨×“×ª PDF
        document.getElementById('downloadPDF').addEventListener('click', downloadMenuPDF);
    </script>
</body>
</html>
